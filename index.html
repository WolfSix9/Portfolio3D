<script>
    // -------------------------------
    // Renderer
    // -------------------------------
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.outputEncoding = THREE.sRGBEncoding;
    document.body.appendChild(renderer.domElement);

    // -------------------------------
    // Scene + Camera
    // -------------------------------
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 2, 5);

    // -------------------------------
    // Orbit Controls (หมุนรอบวัตถุ)
    // -------------------------------
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    // -------------------------------
    // Free Camera Movement (เดินอิสระ)
    // -------------------------------
    let moveForward = false;
    let moveBackward = false;
    let moveLeft = false;
    let moveRight = false;
    const speed = 0.1;
    let pitch = 0, yaw = 0;
    let mouseDown = false;

    document.addEventListener('mousedown', () => { mouseDown = true; });
    document.addEventListener('mouseup', () => { mouseDown = false; });
    document.addEventListener('mousemove', (e) => {
        if (mouseDown) {
            yaw -= e.movementX * 0.002;
            pitch -= e.movementY * 0.002;
            pitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, pitch));
            camera.rotation.set(pitch, yaw, 0);
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.code === 'KeyW') moveForward = true;
        if (e.code === 'KeyS') moveBackward = true;
        if (e.code === 'KeyA') moveLeft = true;
        if (e.code === 'KeyD') moveRight = true;
    });
    document.addEventListener('keyup', (e) => {
        if (e.code === 'KeyW') moveForward = false;
        if (e.code === 'KeyS') moveBackward = false;
        if (e.code === 'KeyA') moveLeft = false;
        if (e.code === 'KeyD') moveRight = false;
    });

    // -------------------------------
    // Light
    // -------------------------------
    scene.add(new THREE.AmbientLight(0xffffff, 1.0));
    const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
    dirLight.position.set(10, 15, 10);
    dirLight.castShadow = true;
    scene.add(dirLight);

    // -------------------------------
    // Background HDRI
    // -------------------------------
    const rgbeLoader = new THREE.RGBELoader();
    rgbeLoader.setDataType(THREE.UnsignedByteType);
    rgbeLoader.load(
        "https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/qwantani_dusk_1_puresky_1k.hdr",
        (texture) => {
            texture.mapping = THREE.EquirectangularReflectionMapping;
            scene.background = texture;
            scene.environment = texture;
        }
    );

    // -------------------------------
    // Load Model
    // -------------------------------
    const mtlLoader = new THREE.MTLLoader();
    mtlLoader.setPath("Model/");
    mtlLoader.load("home.mtl", (materials) => {
        materials.preload();
        for (let key in materials.materials) {
            let mat = materials.materials[key];
            mat.transparent = false;
            mat.opacity = 1.0;
        }

        const objLoader = new THREE.OBJLoader();
        objLoader.setMaterials(materials);
        objLoader.setPath("Model/");
        objLoader.load(
            "home.obj",
            (object) => {
                object.traverse((child) => {
                    if (child.isMesh) {
                        child.material.transparent = false;
                        child.material.opacity = 1.0;
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                object.scale.set(50, 50, 50);
                object.position.set(0, -25, 0);
                scene.add(object);
                document.getElementById("loading").style.display = "none";
            },
            (xhr) => {
                document.getElementById("loading").innerText =
                    "กำลังโหลด... " + Math.round((xhr.loaded / xhr.total) * 100) + "%";
            },
            (error) => {
                console.error("❌ โหลดโมเดลไม่สำเร็จ:", error);
                document.getElementById("loading").innerText =
                    "เกิดข้อผิดพลาดในการโหลดโมเดล!";
            }
        );
    });

    // -------------------------------
    // Animate
    // -------------------------------
    function animate() {
        requestAnimationFrame(animate);

        // การเคลื่อนกล้องอิสระ
        const direction = new THREE.Vector3();
        camera.getWorldDirection(direction);

        if (moveForward) camera.position.addScaledVector(direction, speed);
        if (moveBackward) camera.position.addScaledVector(direction, -speed);
        if (moveLeft) came
