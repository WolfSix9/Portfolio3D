<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio 3D Model Viewer (FPS Mode)</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: #000;
      }
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
        color: #fff;
        font-family: sans-serif;
        font-size: 22px;
      }
    </style>
  </head>

  <body>
    <div id="loading">กำลังโหลดโมเดล...</div>

    <!-- โหลดไลบรารี -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/RGBELoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>

    <script>
      // -------------------------------
      // สร้าง Renderer
      // -------------------------------
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.outputEncoding = THREE.sRGBEncoding;
      document.body.appendChild(renderer.domElement);

      // -------------------------------
      // สร้าง Scene และ Camera
      // -------------------------------
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

      // -------------------------------
      // FPS Controls (Pointer Lock)
      // -------------------------------
      const controls = new THREE.PointerLockControls(camera, document.body);
      document.body.addEventListener("click", () => {
        controls.lock();
      });

      const velocity = new THREE.Vector3();
      const direction = new THREE.Vector3();
      const move = { forward: false, backward: false, left: false, right: false, up: false };
      const speed = 200.0;
      const jumpStrength = 350.0;
      let canJump = false;

      document.addEventListener("keydown", (e) => {
        switch (e.code) {
          case "KeyW": move.forward = true; break;
          case "KeyS": move.backward = true; break;
          case "KeyA": move.left = true; break;
          case "KeyD": move.right = true; break;
          case "Space":
            if (canJump) {
              velocity.y += jumpStrength;
              canJump = false;
            }
            break;
        }
      });

      document.addEventListener("keyup", (e) => {
        switch (e.code) {
          case "KeyW": move.forward = false; break;
          case "KeyS": move.backward = false; break;
          case "KeyA": move.left = false; break;
          case "KeyD": move.right = false; break;
        }
      });

      // -------------------------------
      // แสงและพื้น
      // -------------------------------
      scene.add(new THREE.AmbientLight(0xffffff, 1.0));
      const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
      dirLight.position.set(10, 15, 10);
      dirLight.castShadow = true;
      scene.add(dirLight);

      const groundTex = new THREE.TextureLoader().load(
        "https://film2147.github.io/modelwork3/asphalt-road-texture-dark-gray-color_1017-20231.jpg"
      );
      groundTex.wrapS = groundTex.wrapT = THREE.RepeatWrapping;
      groundTex.repeat.set(6, 6);

      const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(1000, 1000),
        new THREE.MeshStandardMaterial({ map: groundTex })
      );
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);

      // -------------------------------
      // โหลด HDRI พื้นหลัง
      // -------------------------------
      const rgbeLoader = new THREE.RGBELoader();
      rgbeLoader.setDataType(THREE.UnsignedByteType);
      rgbeLoader.load(
        "https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/qwantani_dusk_1_puresky_1k.hdr",
        (texture) => {
          texture.mapping = THREE.EquirectangularReflectionMapping;
          scene.background = texture;
          scene.environment = texture;
        }
      );

      // -------------------------------
      // โหลดโมเดล
      // -------------------------------
      const mtlLoader = new THREE.MTLLoader();
      mtlLoader.setPath("Model/");
      mtlLoader.load("home.mtl", (materials) => {
        materials.preload();
        const objLoader = new THREE.OBJLoader();
        objLoader.setMaterials(materials);
        objLoader.setPath("Model/");
        objLoader.load("home.obj", (object) => {
          object.traverse((child) => {
            if (child.isMesh) {
              child.material.transparent = false;
              child.material.opacity = 1.0;
              child.castShadow = true;
              child.receiveShadow = true;
            }
          });
          object.scale.set(1, 1, 1);
          object.position.set(0, 0, 0);
          scene.add(object);
          document.getElementById("loading").style.display = "none";
        });
      });

      // -------------------------------
      // กล้องเริ่มต้น
      // -------------------------------
      camera.position.set(20, 20, 20);
      controls.getObject().position.y = 10;
      scene.add(controls.getObject());

      // -------------------------------
      // การเคลื่อนไหวของกล้อง
      // -------------------------------
      const clock = new THREE.Clock();

      function animate() {
        const delta = clock.getDelta();
        const friction = 10.0;

        velocity.x -= velocity.x * friction * delta;
        velocity.z -= velocity.z * friction * delta;

        velocity.y -= 9.8 * 100.0 * delta; // แรงโน้มถ่วง

        direction.z = Number(move.forward) - Number(move.backward);
        direction.x = Number(move.right) - Number(move.left);
        direction.normalize();

        if (move.forward || move.backward) velocity.z -= direction.z * speed * delta;
        if (move.left || move.right) velocity.x -= direction.x * speed * delta;

        controls.moveRight(-velocity.x * delta);
        controls.moveForward(-velocity.z * delta);
        controls.getObject().position.y += velocity.y * delta;

        // ตรวจพื้น
        if (controls.getObject().position.y < 10) {
          velocity.y = 0;
          controls.getObject().position.y = 10;
          canJump = true;
        }

        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      }
      animate();

      // -------------------------------
      // ปรับขนาดหน้าจอ
      // -------------------------------
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
